# SPDX-License-Identifier: MIT OR Apache-2.0
# SPDX-FileCopyrightText: The Ferrocene Developers

# This Ubuntu 22.04 container is only used to grab a more recent QEMU, the real
# container is below (FROM ubuntu:18.04). This is needed because the version of
# QEMU in the Ubuntu 18.04 archives is too old, so we install QEMU on Ubuntu
# 22.04 and copy the binary over to 18.04.
#
# This actually works because the qemu-user-static package contains statically
# linked versions of QEMU, with no dynamically linked libraries. This means we
# can just copy it to a different system and it won't have any problems. Do NOT
# use the same approach for other dependencies missing in Ubuntu 18.04 unless
# you know what you're doing.
FROM ubuntu:22.04 AS jammy
RUN apt-get update \
    && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends qemu-user-static

FROM ubuntu:18.04

RUN apt-get update \
    # Update all the dependencies
    && DEBIAN_FRONTEND=noninteractive apt-get upgrade -y \
    # Install required packages
    && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        git \
        build-essential \
        ninja-build \
        openssh-client \
        file \
        gdb \
        curl \
        ca-certificates \
        libedit-dev \
        libssl-dev \
        zlib1g-dev \
        moreutils \
        zstd \
        sudo \
        # Needed to support the QEMU copied over from Ubuntu 22.04 (see above).
        # Replace this with qemu-user-static once we're not on Ubuntu 18.04.
        binfmt-support \
        # Needed for aarch64-unknown-linux-gnu cross-compilation
        g++-aarch64-linux-gnu \
        binutils-aarch64-linux-gnu \
        libc6-dev-arm64-cross \
        # Needed for thumbv7em-none-eabihf cross-compilation
        gcc-arm-none-eabi \
        # Needed for the wasm32-unknown-unknown target
        clang \
        # Needed to install AWS CLI during the build:
        unzip \
        # Needed to install git during the build:
        dh-autoreconf \
        libcurl4-gnutls-dev \
        libexpat1-dev \
        gettext \
        libz-dev \
        libssl-dev \
    # Remove files that are not useful in the final image, and can be
    # regenerated by running `apt-get update`
    && rm -rf /var/lib/apt/lists/*

# Grab the newer QEMU from Ubuntu 22.04
# This requires the binfmt-support package, which is normally a dependency of
# qemu-user-static.
COPY --from=jammy /usr/bin/qemu-aarch64-static /usr/bin/qemu-aarch64-static
COPY --from=jammy /usr/libexec/qemu-binfmt/aarch64-binfmt-P /usr/libexec/qemu-binfmt/aarch64-binfmt-P
COPY --from=jammy /usr/share/binfmts/qemu-aarch64 /usr/share/binfmts/qemu-aarch64

# We need a newer Python than what's included in Ubuntu 18.04, so we have to
# build it from source. Python 3.10.x has been chosen as it's the same minor
# release shipped with Ubuntu 22.04 LTS.
RUN mkdir /tmp/python \
    && cd /tmp/python \
    && curl -OL https://www.python.org/ftp/python/3.10.10/Python-3.10.10.tar.xz \
    && echo "0419e9085bf51b7a672009b3f50dbf1859acdf18ba725d0ec19aa5c8503f0ea3 Python-3.10.10.tar.xz" | sha256sum -c \
    && tar xf Python-3.10.10.tar.xz --strip-components=1 \
    && ./configure \
    && make -j$(nproc) \
    && make install \
    && rm -rf /tmp/git

# The REUSE tool is used to check the licensing status. It's not available in
# the Ubuntu archives so we have to install it with pip.
COPY reuse-requirements.txt /tmp/reuse-requirements.txt
RUN python3 -m pip install -r /tmp/reuse-requirements.txt && \
    rm -rf /tmp/reuse-requirements.txt

# Install git 2.25 from source. The version included in Ubuntu 18.04 is too old
# to perform fast clones of the LLVM monorepo.
RUN mkdir /tmp/git \
    && cd /tmp/git \
    && curl -OL https://mirrors.edge.kernel.org/pub/software/scm/git/git-2.25.5.tar.xz \
    && echo "164dec6d31843a436c0db2acb79ce49a56f703f587e7c127cf421604d5570bba git-2.25.5.tar.xz" | sha256sum -c \
    && tar xf git-2.25.5.tar.xz --strip-components=1 \
    && make configure \
    && ./configure --prefix=/usr/local \
    && make -j$(nproc) \
    && make install \
    && rm -rf /tmp/git

# Install a recent NodeJS version, as the one shipped in Ubuntu 18.04 is too
# old to run the rustdoc-js test suite.
RUN mkdir /opt/nodejs \
    && curl -Lo /tmp/nodejs.tar.xz https://nodejs.org/dist/v20.10.0/node-v20.10.0-linux-x64.tar.xz \
    && echo "3fe4ec5d70c8b4ffc1461dec83ab23fc70124e137c4cbbe1ccc9d6ae6ec04a7d /tmp/nodejs.tar.xz" | sha256sum -c \
    && tar xf /tmp/nodejs.tar.xz -C /opt/nodejs --strip-components=1 \
    && rm /tmp/nodejs.tar.xz
ENV PATH "/opt/nodejs/bin:$PATH"

# Install AWS CLI from the published binaries, as no source tarball is provided
# and the version in the Ubuntu 18.04 archive is too old and doesn't support
# `aws ecr get-login-password`.
RUN curl -Lo /tmp/awscli.zip https://awscli.amazonaws.com/awscli-exe-linux-x86_64-2.12.4.zip \
    && echo "0556162145e68889a27f835307b9dad56de60fda4256d2e246e9699f24535a08  /tmp/awscli.zip" | sha256sum -c \
    && unzip -q -d /tmp/awscli /tmp/awscli.zip \
    && /tmp/awscli/aws/install \
    && rm -rf /tmp/awscli /tmp/awscli.zip

# Install cmake from source code, as the version in the Ubuntu 18.04 archives
# is too old to build the latest LLVM.
RUN curl -Lo /tmp/cmake.tar.gz https://github.com/Kitware/CMake/releases/download/v3.21.1/cmake-3.21.1.tar.gz \
    && echo "fac3915171d4dff25913975d712f76e69aef44bf738ba7b976793a458b4cfed4  /tmp/cmake.tar.gz" | sha256sum -c \
    && mkdir /tmp/cmake \
    && cd /tmp/cmake \
    && tar --strip-components=1 -xzf /tmp/cmake.tar.gz \
    && ./configure \
    && make -j$(nproc) \
    && make install \
    && rm -rf /tmp/cmake /tmp/cmake.tar.gz

# To run chroot inside the container we need sudo access. Copy a configuration
# file allowing all users inside the container to use sudo.
COPY sudoers /etc/sudoers

# Tell programs relying on the system language (like Python) to use UTF-8.
ENV LANG=C.UTF-8

# Automatic compiler detection doesn't work for some targets.
ENV CC_aarch64_unknown_none=aarch64-linux-gnu-gcc
ENV CXX_aarch64_unknown_none=aarch64-linux-gnu-g++
ENV CC_aarch64_unknown_ferrocenecoretest=aarch64-linux-gnu-gcc
ENV CXX_aarch64_unknown_ferrocenecoretest=aarch64-linux-gnu-g++

RUN mkdir /home/ci \
    && addgroup --gid 1000 ci \
    && addgroup --gid 1001 ci-usergroup \
    && adduser --home /home/ci --uid 1000 --gid 1000 --gecos "" --disabled-password ci \
    && adduser --uid 1001 --gid 1001 --gecos "" --disabled-password ci-user \
    && chown -R ci: /home/ci
USER ci
WORKDIR /home/ci
