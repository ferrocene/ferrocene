# SPDX-License-Identifier: MIT OR Apache-2.0
# SPDX-FileCopyrightText: The Ferrocene Developers

# TODO move to 24.04, when available... 23.10 support window is just 9 months
FROM ubuntu:23.10

RUN apt-get update \
    # Update all the dependencies
    && DEBIAN_FRONTEND=noninteractive apt-get upgrade -y \
    # Install required packages
    && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        git \
        build-essential \
        gcc-multilib \
        ninja-build \
        openssh-client \
        file \
        gdb \
        curl \
        ca-certificates \
        python3 \
        python3-venv \
        python3-pip \
        libedit-dev \
        libssl-dev \
        zlib1g-dev \
        moreutils \
        cmake \
        python-is-python3 \
        # Needed by the `commit-checks` CI job:
        llvm-17-tools \
        llvm-17-dev \
        awscli \
    # Remove files that are not useful in the final image, and can be
    # regenerated by running `apt-get update`
    && rm -rf /var/lib/apt/lists/*

# Python3 is installed by apt, and we use the same version than the container ubuntu-20
COPY reuse-requirements.txt /tmp/reuse-requirements.txt
RUN python3 -m pip install --break-system-packages -r /tmp/reuse-requirements.txt && \
    rm -rf /tmp/reuse-requirements.txt

# Tell programs relying on the system language (like Python) to use UTF-8.
ENV LANG=C.UTF-8

RUN mkdir /home/ci \
    && deluser --remove-home ubuntu \
    && addgroup --gid 1000 ci \
    && addgroup --gid 1001 ci-usergroup \
    && adduser --home /home/ci --uid 1000 --gid 1000 --gecos "" --disabled-password ci \
    && adduser --uid 1001 --gid 1001 --gecos "" --disabled-password ci-user \
    && chown -R ci: /home/ci
USER ci
WORKDIR /home/ci
